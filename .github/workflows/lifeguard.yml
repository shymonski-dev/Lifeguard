name: Lifeguard

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lifeguard-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Guard stand-alone project boundaries
        run: |
          set -euo pipefail
          allowed_top_level='^(\.github|src|tests|docs|examples|scripts|trust_profiles|validation|extracts|LICENSE|README\.md|pyproject\.toml|\.gitignore)$'
          unexpected_paths="$(git ls-files | awk -F/ '{print $1}' | sort -u | grep -Ev "${allowed_top_level}" || true)"
          if [ -n "${unexpected_paths}" ]; then
            echo "Unexpected top-level paths found:"
            echo "${unexpected_paths}"
            exit 1
          fi

      - name: Install Lifeguard and Sigstore
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
          python -m pip install sigstore

      - name: Run secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run static security scan
        run: |
          python -m pip install bandit[toml]
          # Fail on medium or high severity findings with at least medium confidence.
          # B104 is intentionally triggered by container gateway binding behavior.
          bandit -q -r src/lifeguard -ll -ii -s B104

      - name: Run tests
        run: pytest -q tests

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency review
        uses: actions/dependency-review-action@v4

  lifeguard-sigstore-release:
    if: github.event_name != 'pull_request'
    needs: lifeguard-tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Lifeguard and Sigstore
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
          python -m pip install sigstore

      - name: Run Sigstore release
        run: |
          lifeguard init --path /tmp/lifeguard_spec.json --profile secure_code_review_local --force
          lifeguard release \
            --spec /tmp/lifeguard_spec.json \
            --evidence /tmp/lifeguard_evidence.jsonl \
            --output /tmp/lifeguard_release_output \
            --signing-mode sigstore \
            --sigstore-repository "${{ github.repository }}" \
            --sigstore-workflow ".github/workflows/lifeguard.yml"
          test -f /tmp/lifeguard_release_output/release_manifest.json

      - name: Validate Sigstore manifest fields
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          payload = json.loads(Path("/tmp/lifeguard_release_output/release_manifest.json").read_text())
          assert payload["signature"]["algorithm"] == "sigstore-bundle"
          assert payload["signature"]["verified"] is True
          assert payload["verification"]["passed"] is True
          PY

      - name: Verify Sigstore compliance pack
        run: |
          lifeguard compliance-pack-verify --pack /tmp/lifeguard_release_output/compliance_pack

      - name: Run key-based release and verify compliance pack
        run: |
          printf "lifeguard-ci-signing-key-material-123456789" > /tmp/lifeguard_ci_signing.key
          lifeguard release \
            --spec /tmp/lifeguard_spec.json \
            --evidence /tmp/lifeguard_evidence_hmac.jsonl \
            --output /tmp/lifeguard_release_output_hmac \
            --signing-mode hmac \
            --signing-key-file /tmp/lifeguard_ci_signing.key
          test -f /tmp/lifeguard_release_output_hmac/release_manifest.json
          lifeguard compliance-pack-verify \
            --pack /tmp/lifeguard_release_output_hmac/compliance_pack \
            --signing-key-file /tmp/lifeguard_ci_signing.key

      - name: Create Sigstore badge file
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          release_dir = Path("/tmp/lifeguard_release_output")
          payload = json.loads((release_dir / "release_manifest.json").read_text(encoding="utf-8"))
          signature = payload.get("signature", {})
          verified = (
              isinstance(signature, dict)
              and signature.get("algorithm") == "sigstore-bundle"
              and bool(signature.get("verified"))
          )
          badge = {
              "generated_by": "github-workflow",
              "label": "Sigstore",
              "message": "verified" if verified else "failed",
              "color": "brightgreen" if verified else "red",
              "passed": bool(verified),
          }
          (release_dir / "sigstore_badge.json").write_text(
              json.dumps(badge, indent=2) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Upload release artifacts and badges
        uses: actions/upload-artifact@v4
        with:
          name: lifeguard-sigstore-release-artifacts
          if-no-files-found: error
          path: |
            /tmp/lifeguard_release_output/release_manifest.json
            /tmp/lifeguard_release_output/release_anchor.json
            /tmp/lifeguard_release_output/owasp_control_badge.json
            /tmp/lifeguard_release_output/sigstore_badge.json
            /tmp/lifeguard_release_output/**/*.sigstore.bundle.json

      - name: Publish badge summary
        run: |
          {
            echo "### Release badge artifacts"
            echo "- Sigstore badge: \`sigstore_badge.json\`"
            echo "- Security control matrix badge: \`owasp_control_badge.json\`"
          } >> "$GITHUB_STEP_SUMMARY"
